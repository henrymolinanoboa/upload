<?xml version="1.0" encoding="UTF-8"?>
<sequence name="ServiceNowSysUserSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- ServiceNowSysUserSeq .Ini --------------------" />
    </log>
    <!-- Recuperar el sys-id  de un usuario-->
    <!-- recibe 'user_id' como input -->
    <filter regex="true" source="boolean($ctx:user_id)">
        <then>
            <property name="uri.var.host" expression="fn:concat(get-property('SERVICE_NOW_SYS_USER_URL'),'?user_name=',$ctx:user_id,'@pichincha.com')" />
            <property description="HTTP_METHOD:POST" name="HTTP_METHOD" scope="axis2" type="STRING" value="GET" />
            <call-template target="SetCredentialsTemplate">
                <with-param name="system" value="SERVICE_NOW" />
            </call-template>
            <call>
                <endpoint key="ServiceNowEP" />
            </call>
            <log description="seq" level="custom">
                <property name="seq" value="-------------------- ServiceNowSysUserSeq .Resultado --------------------" />
                <property name="uri.var.host" expression="$ctx:uri.var.host"/>
                <property name="HTTP_SC" expression="get-property('axis2', 'HTTP_SC')" />
            </log>
            <filter regex=".*20.*" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <property name="sys_id" expression="//sys_id/text()" />
                </then>
                <else>
                    <property name="sys_id" value="" />
                </else>
            </filter>
        </then>
        <else>
            <property name="sys_id" value="" />
        </else>
    </filter>
    <!-- devuelve 'req_id' como output -->
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- ServiceNowSysUserSeq .Fin --------------------" />
        <property name="sys_id" expression="$ctx:sys_id" />
    </log>
</sequence>
